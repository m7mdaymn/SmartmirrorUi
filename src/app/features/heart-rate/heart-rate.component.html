<div class="heart-page">
  <!-- Back Button -->
  <button
    class="back-btn"
    (click)="onBackClick()"
    [disabled]="isDisabling"
    [class.disabling]="isDisabling">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M19 12H5M12 19l-7-7 7-7"/>
    </svg>
    <span *ngIf="isDisabling" class="disabling-text">Disabling...</span>
  </button>

  <!-- Header -->
  <div class="page-header">
    <div class="title-section">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
      </svg>
      <div class="title-text">
        <h1>Heart Rate Monitor</h1>
        <p class="subtitle">MAX30105 Pulse & Blood Pressure Sensor</p>
      </div>
    </div>

    <div class="status-badge" [class]="statusClass">
      <div class="status-dot"></div>
      <span>{{ statusText }}</span>
    </div>
  </div>

  <!-- Initializing State -->
  <div class="state-container" *ngIf="state === 'initializing'">
    <div class="state-content">
      <div class="spinner-heart">
        <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="#ff6b6b" stroke-width="2">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
        </svg>
      </div>
      <h2>Initializing Sensor...</h2>
      <p>Please wait while we prepare the MAX30105 sensor</p>
    </div>
  </div>

  <!-- Waiting for Finger State -->
  <div class="state-container" *ngIf="state === 'waiting_finger'">
    <div class="state-content">
      <div class="pulse-heart" [class.active]="true">
        <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="#ff6b6b" stroke-width="2">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
        </svg>
      </div>
      <h2>üëÜ Place Your Finger on Sensor</h2>
      <p>Position your finger gently on the MAX30105 sensor</p>

      <div class="instructions">
        <div class="instruction-item">
          <span class="icon">‚úì</span>
          <span>Clean your finger first</span>
        </div>
        <div class="instruction-item">
          <span class="icon">‚úì</span>
          <span>Cover the entire sensor</span>
        </div>
        <div class="instruction-item">
          <span class="icon">‚úì</span>
          <span>Press gently but firmly</span>
        </div>
        <div class="instruction-item">
          <span class="icon">‚úì</span>
          <span>Keep finger still for 15 seconds</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Measuring State -->
  <div class="state-container" *ngIf="showMeasuringState">
    <div class="state-content">
      <div class="measuring-animation">
        <svg width="140" height="140" viewBox="0 0 24 24" fill="none" stroke="#ff6b6b" stroke-width="2">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
        </svg>

        <!-- Circular progress -->
        <svg class="progress-ring" width="200" height="200">
          <circle
            class="progress-ring-bg"
            cx="100"
            cy="100"
            r="90"
          />
          <circle
            class="progress-ring-progress"
            cx="100"
            cy="100"
            r="90"
            [style.stroke-dashoffset]="565 - (565 * progressPercentage / 100)"
          />
        </svg>
      </div>

      <h2>ü´Ä Measuring Your Heart Rate</h2>
      <p class="measuring-text">Keep your finger completely still...</p>

      <div class="progress-info">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="progressPercentage"></div>
        </div>
        <div class="progress-stats">
          <span>{{ progressPercentage.toFixed(0) }}% Complete</span>
          <span>{{ timeRemainingText }} remaining</span>
        </div>
      </div>

      <div class="measuring-tips">
        <p>‚ö†Ô∏è Do not remove your finger</p>
        <p>‚ö†Ô∏è Stay relaxed and breathe normally</p>
      </div>
    </div>
  </div>

  <!-- Results State -->
  <div class="content-grid" *ngIf="showResults">
    <!-- Primary Metrics -->
    <div class="primary-metrics">
      <div class="metric-card pulse">
        <div class="metric-label">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
          </svg>
          <span>Heart Rate</span>
        </div>
        <div class="metric-value">
          <span class="big-number">{{ heartRate }}</span>
          <span class="unit">BPM</span>
        </div>
        <div class="metric-status">
          <span [class]="statusClass">{{ getHeartRateCategory() }}</span>
        </div>
      </div>

      <div class="metric-card bp">
        <div class="metric-label">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
          </svg>
          <span>Blood Pressure</span>
        </div>
        <div class="metric-value">
          <span class="big-number">{{ bloodPressure }}</span>
          <span class="unit">mmHg</span>
        </div>
        <div class="bp-breakdown">
          <div class="bp-item">
            <span class="bp-label">Systolic:</span>
            <span class="bp-value">{{ systolic }}</span>
          </div>
          <div class="bp-item">
            <span class="bp-label">Diastolic:</span>
            <span class="bp-value">{{ diastolic }}</span>
          </div>
        </div>
        <div class="metric-status">
          <span [class]="statusClass">{{ getBloodPressureCategory() }}</span>
        </div>
      </div>
    </div>

    <!-- Reference Tables -->
    <div class="reference-tables">
      <!-- Heart Rate Reference -->
      <div class="reference-card">
        <div class="reference-header">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
          </svg>
          <h3>Heart Rate Reference</h3>
        </div>
        <div class="reference-table">
          <div class="table-row" [class.current]="heartRate < 60">
            <div class="category">
              <div class="indicator bradycardia"></div>
              <span>Bradycardia</span>
            </div>
            <div class="range">< 60 BPM</div>
          </div>
          <div class="table-row" [class.current]="heartRate >= 60 && heartRate <= 100">
            <div class="category">
              <div class="indicator normal"></div>
              <span>Normal</span>
            </div>
            <div class="range">60 - 100 BPM</div>
          </div>
          <div class="table-row" [class.current]="heartRate > 100 && heartRate <= 120">
            <div class="category">
              <div class="indicator elevated"></div>
              <span>Elevated</span>
            </div>
            <div class="range">101 - 120 BPM</div>
          </div>
          <div class="table-row" [class.current]="heartRate > 120">
            <div class="category">
              <div class="indicator tachycardia"></div>
              <span>Tachycardia</span>
            </div>
            <div class="range">> 120 BPM</div>
          </div>
        </div>
      </div>

      <!-- Blood Pressure Reference -->
      <div class="reference-card">
        <div class="reference-header">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
          </svg>
          <h3>Blood Pressure Reference</h3>
        </div>
        <div class="reference-table">
          <div class="table-row" [class.current]="systolic < 90 || diastolic < 60">
            <div class="category">
              <div class="indicator hypotension"></div>
              <span>Hypotension</span>
            </div>
            <div class="range">< 90/60 mmHg</div>
          </div>
          <div class="table-row" [class.current]="systolic >= 90 && systolic < 120 && diastolic >= 60 && diastolic < 80">
            <div class="category">
              <div class="indicator normal"></div>
              <span>Normal</span>
            </div>
            <div class="range">90-119 / 60-79 mmHg</div>
          </div>
          <div class="table-row" [class.current]="systolic >= 120 && systolic < 130 && diastolic < 80">
            <div class="category">
              <div class="indicator elevated"></div>
              <span>Elevated</span>
            </div>
            <div class="range">120-129 / < 80 mmHg</div>
          </div>
          <div class="table-row" [class.current]="(systolic >= 130 && systolic < 140) || (diastolic >= 80 && diastolic < 90)">
            <div class="category">
              <div class="indicator stage1"></div>
              <span>Stage 1 Hypertension</span>
            </div>
            <div class="range">130-139 / 80-89 mmHg</div>
          </div>
          <div class="table-row" [class.current]="systolic >= 140 || diastolic >= 90">
            <div class="category">
              <div class="indicator stage2"></div>
              <span>Stage 2 Hypertension</span>
            </div>
            <div class="range">‚â• 140 / ‚â• 90 mmHg</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div class="state-container error-state" *ngIf="showError">
    <div class="state-content">
      <div class="error-icon">
        <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="#ff4757" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="15" y1="9" x2="9" y2="15"/>
          <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
      </div>
      <h2>‚ùå Measurement Failed</h2>
      <p class="error-message">{{ errorMessage }}</p>

      <button
        class="retry-btn"
        (click)="onRetry()"
        [disabled]="isRetrying">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="23 4 23 10 17 10"/>
          <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
        </svg>
        <span *ngIf="!isRetrying">Retry Measurement</span>
        <span *ngIf="isRetrying">Retrying...</span>
      </button>

      <div class="error-tips">
        <h4>Troubleshooting Tips:</h4>
        <ul>
          <li>Ensure sensor is properly connected</li>
          <li>Check that your finger is clean and dry</li>
          <li>Press gently but firmly on the sensor</li>
          <li>Make sure sensor LEDs are illuminated</li>
          <li>Try a different finger if needed</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <div class="last-updated" *ngIf="showResults">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <polyline points="12 6 12 12 16 14"/>
      </svg>
      <span>Last measurement: {{ lastUpdated }}</span>
    </div>
    <div class="device-info">
      <span>MAX30105 Sensor ‚Ä¢ ESP32-S3</span>
    </div>
  </div>
</div>
