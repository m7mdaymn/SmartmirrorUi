<div class="gas-page">
  <!-- Back Button with Disable Logic -->
  <button
    class="back-btn"
    (click)="onBackClick()"
    [disabled]="isDisabling"
    [class.disabling]="isDisabling">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M19 12H5M12 19l-7-7 7-7"/>
    </svg>
    <span *ngIf="isDisabling" class="disabling-text">Disabling...</span>
  </button>

  <!-- Emergency Alert -->
  <div class="emergency-alert" *ngIf="isDangerous && !loading">
    <div class="alert-content">
      <div class="alert-icon">üö®</div>
      <div class="alert-text">
        <h3>POOR AIR QUALITY DETECTED!</h3>
        <p>Open windows and ventilate immediately.</p>
      </div>
    </div>
  </div>

  <!-- Header -->
  <div class="page-header">
    <div class="title-section">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
        <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
      </svg>
      <div class="title-text">
        <h1>Air Quality Monitor</h1>
        <p class="subtitle">Advanced analysis from MQ135 sensor</p>
      </div>
    </div>

    <div class="system-status" [class]="connectionStatus">
      <div class="status-dot"></div>
      <span>{{ connectionStatusText }}</span>
      <small *ngIf="lastUpdated">Last update: {{ lastUpdated }}</small>
    </div>
  </div>

  <!-- Loading State with Progress -->
  <div class="loading-overlay" *ngIf="loading">
    <div class="loading-content">
      <div class="loading-spinner">
        <svg width="80" height="80" viewBox="0 0 80 80">
          <circle cx="40" cy="40" r="35" fill="none" stroke="rgba(46, 204, 113, 0.2)" stroke-width="6"/>
          <circle
            cx="40"
            cy="40"
            r="35"
            fill="none"
            stroke="#2ecc71"
            stroke-width="6"
            stroke-dasharray="220"
            [attr.stroke-dashoffset]="220 - (220 * loadingProgress / 100)"
            class="progress-circle"/>
        </svg>
        <div class="progress-percentage">{{ loadingProgress | number:'1.0-0' }}%</div>
      </div>
      <p class="loading-message">{{ loadingMessage }}</p>
      <div class="loading-bar-container">
        <div class="loading-bar" [style.width.%]="loadingProgress"></div>
      </div>
    </div>
  </div>

  <!-- Error -->
  <div class="error-message" *ngIf="error && !loading">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"/>
      <line x1="12" y1="8" x2="12" y2="12"/>
      <line x1="12" y1="16" x2="12.01" y2="16"/>
    </svg>
    <div>
      <p>{{ error }}</p>
      <p>Tap "Gas Detect" on home screen to enable sensor.</p>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard" *ngIf="latestReading && !loading && !error">
    <!-- Overall Air Quality -->
    <div class="gas-card overall" [class]="qualityClass">
      <div class="gas-header">
        <div class="gas-icon">üí®</div>
        <div>
          <h3>Overall Air Quality</h3>
        </div>
      </div>
      <div class="gas-reading">
        <div class="reading-value">
          {{ quality }}
          <span class="icon">{{ qualityIcon }}</span>
        </div>
        <div class="reading-subtitle">Sensor Reading: {{ rawValue }}</div>
      </div>
      <div class="gas-meter">
        <div class="meter-bar">
          <div class="meter-fill" [style.width.%]="rawPercentage"></div>
          <div class="meter-indicator" [style.left.%]="rawPercentage"></div>
        </div>
        <div class="meter-labels">
          <span>Excellent</span>
          <span>Moderate</span>
          <span>Hazardous</span>
        </div>
      </div>
      <div class="gas-status">
        <div class="status-badge" [class]="qualityClass">{{ quality.toUpperCase() }}</div>
      </div>
    </div>

    <!-- Carbon Dioxide Card -->
    <div class="gas-card co2" [class]="co2Class">
      <div class="gas-header">
        <div class="gas-icon">üå´Ô∏è</div>
        <div>
          <h3>Carbon Dioxide</h3>
          <div class="gas-formula">CO‚ÇÇ Estimate</div>
        </div>
      </div>
      <div class="gas-reading">
        <div class="reading-value">{{ co2Ppm }} <span class="unit">ppm</span></div>
        <div class="reading-subtitle">{{ co2Status }}</div>
      </div>
      <div class="gas-meter">
        <div class="meter-bar">
          <div class="meter-fill" [style.width.%]="co2Percentage"></div>
          <div class="meter-indicator" [style.left.%]="co2Percentage"></div>
        </div>
        <div class="meter-labels">
          <span>400 ppm</span>
          <span>1000 ppm</span>
          <span>2000+ ppm</span>
        </div>
      </div>
      <div class="gas-status">
        <div class="status-badge" [class]="co2Class">{{ co2Status.toUpperCase() }}</div>
      </div>
    </div>

    <!-- Smoke Particles Card -->
    <div class="gas-card smoke" [class]="smokeClass">
      <div class="gas-header">
        <div class="gas-icon">üî•</div>
        <div>
          <h3>Smoke Particles</h3>
          <div class="gas-formula">PM Estimate</div>
        </div>
      </div>
      <div class="gas-reading">
        <div class="reading-value">{{ smokeLevel }} <span class="unit">¬µg/m¬≥</span></div>
        <div class="reading-subtitle">{{ smokeStatus }}</div>
      </div>
      <div class="gas-meter">
        <div class="meter-bar">
          <div class="meter-fill" [style.width.%]="smokePercentage"></div>
          <div class="meter-indicator" [style.left.%]="smokePercentage"></div>
        </div>
        <div class="meter-labels">
          <span>Low</span>
          <span>Medium</span>
          <span>High</span>
        </div>
      </div>
      <div class="gas-status">
        <div class="status-badge" [class]="smokeClass">{{ smokeStatus.toUpperCase() }}</div>
      </div>
    </div>
  </div>

  <!-- Environmental Analysis Section -->
  <div class="analysis-section" *ngIf="latestReading && !loading && !error">
    <h2>Environmental Analysis</h2>

    <div class="analysis-grid">
      <!-- Air Quality Score Card -->
      <div class="analysis-card quality-card" [attr.data-level]="qualityClass">
        <div class="card-header">
          <div class="icon-wrapper">
            <span class="emoji">{{ qualityIcon }}</span>
          </div>
          <div class="header-text">
            <h3>Air Quality Score</h3>
            <p class="status-label" [style.color]="qualityColor">{{ quality }}</p>
          </div>
        </div>
        <div class="score-visual">
          <svg width="100" height="100" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="45" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="8"/>
            <circle
              cx="50"
              cy="50"
              r="45"
              fill="none"
              [attr.stroke]="qualityColor"
              stroke-width="8"
              stroke-dasharray="283"
              [attr.stroke-dashoffset]="283 - (283 * airQualityScore / 100)"
              class="score-circle"/>
          </svg>
          <div class="score-number" [style.color]="qualityColor">{{ airQualityScore }}</div>
        </div>
      </div>

      <!-- Gas Levels Indicator -->
      <div class="analysis-card levels-card">
        <div class="card-header">
          <div class="icon-wrapper">
            <span class="emoji">üìä</span>
          </div>
          <div class="header-text">
            <h3>Gas Levels</h3>
            <p class="status-label">{{ environmentStatus }}</p>
          </div>
        </div>
        <div class="quality-bars">
          <div class="quality-item">
            <span>CO‚ÇÇ ({{ co2Ppm }} ppm)</span>
            <div class="bar-container">
              <div class="bar" [style.width.%]="co2Percentage" [style.background]="getCO2Color()"></div>
            </div>
          </div>
          <div class="quality-item">
            <span>Smoke ({{ smokeLevel }} ¬µg/m¬≥)</span>
            <div class="bar-container">
              <div class="bar" [style.width.%]="smokePercentage" [style.background]="getSmokeColor()"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recommendations Card -->
      <div class="analysis-card recommendations-card">
        <div class="card-header">
          <div class="icon-wrapper">
            <span class="emoji">üí°</span>
          </div>
          <div class="header-text">
            <h3>Safety Recommendations</h3>
          </div>
        </div>
        <div class="recommendations-list">
          <div class="recommendation" *ngFor="let rec of recommendations">
            <span class="rec-icon">{{ rec.icon }}</span>
            <span class="rec-text">{{ rec.text }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
